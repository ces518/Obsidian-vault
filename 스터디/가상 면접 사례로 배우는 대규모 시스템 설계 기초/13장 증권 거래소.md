# 개요

**거래소의 본질:** 거래소의 기본 기능은 **구매자와 판매자를 효율적으로 연결**하는 것

**거래 방식의 진화:**

- 과거엔 사람끼리 직접(물물교환/외침/눈으로 확인 가능한 상품) 거래하던 것을,
- 오늘날엔 **주문 처리와 매칭을 컴퓨터(고성능 시스템)가 전자적으로 자동 처리**.
- 거래 목적도 단순 교환을 넘어 **차익 실현/중개** 등으로 확대.

**거래소의 다양성:** NYSE, 나스닥 같은 전통 강자 외에도

- 특정 금융 세그먼트에 집중하거나,
- 기술을 특히 강조하거나,
- **공정성**에 초점을 둔 형태 등 다양한 거래소가 존재한다

**규모 감(트래픽/볼륨) 예시:**

- **NYSE**: 하루에 “수십 억 건” 규모의 거래(주문/거래량 맥락) 처리 언급
- **HKEX**: 하루에 “약 2천억 건”의 주식 거래 처리 언급
- 그리고 **시가총액 기준 ‘1조 달러 클럽’ 대형 거래소**를 그림(13.1)으로 소개.

---

# 요구사항

### 1. 거래 대상

- **주식만 거래**
    - 옵션, 선물, 파생상품 ❌
    - → 도메인 복잡도 축소

### 2. 주문 유형

- 지원:
    - **신규 주문**
    - **체결되지 않은 주문 취소**
- 주문 타입:
    - ✅ **지정가 주문 (Limit Order)**
    - ❌ 시장가 주문
    - ❌ 조건부 주문

📌 의미

→ 매칭 로직과 호가창(order book)이 **가격 우선 + 시간 우선** 구조로 단순화됨

### 3. 거래 시간

- **정규 장중 거래만**
    - 시간 외 거래(after-hours) ❌

### 4. 핵심 기능

- 새로운 지정가 주문 접수
- 미체결 주문 취소
- **체결 시 실시간 알림**
- **호가창(order book) 실시간 갱신**
    - 매수/매도 주문 목록

### 5. 사용자·규모

- 동시 사용자: **수만 명**
- 종목 수: **최소 100개 주식**
- 주문량: **하루 수십억 건**

→ 소규모 아님, **중~대규모 거래소**

### 6. 규제 요구사항 (중요)

- 거래소는 **규제 시설(regulated facility)**
- **Risk Check(위험성 점검)** 필수
    - 예:
        - 사용자 1명이 하루에 AAPL 100만 주 이상 거래 ❌
- **주문 전 규칙 위반 여부를 반드시 검증**

### 7. 자금(지갑) 관리

- 주문 전에:
    - **충분한 자금 보유 여부 확인**
- 미체결 주문에 사용된 자금:
    - **락(lock) 처리**
    - 다른 주문에 재사용 ❌

📌 이 부분이 핵심

- 단순 매칭 시스템 ❌
- **자금 원장 + 주문 원장 + 락 자금 관리**가 함께 가야 함

---

# 비기능 요구사항

### 1. 가용성 (Availability)

- **최소 99.99%**
- 몇 초 장애 → 신뢰·평판 치명적

### 2. 결함 내성 (Fault Tolerance)

- 장애 발생 시:
    - **파급 최소화**
    - **빠른 복구 메커니즘 필수**

### 3. 지연 시간 (Latency)

- **밀리초(ms) 단위**
- 특히 **p99 지연 시간** 중요
    - 일부 사용자라도 느리면 거래 경험 망함
- 왕복 지연:
    - 주문 접수 → 체결 결과 반환

### 4. 보안 (Security)

- 계정 관리 시스템 필수
- **KYC (고객 신원 확인)** 필요
- 공개 리소스:
    - **DDoS 방어** 필수 (시장 데이터 페이지 등)

## 5. 개략적 트래픽 규모 계산

- 종목 수: 100
- 주문 수: 하루 **10억 건**
- 거래 시간: 하루 **6.5시간**

**평균 QPS**

```jsx
10억 / (6.5 × 3600) ≈ 43,000 QPS
```

**최대 QPS (피크타임)**

```jsx
**약 5배 → 215,000 QPS**
```

📌 장 시작 직후 / 장 마감 직전이 피크

- 핵심은:
    - **규모**
    - **규제**
    - **자금 락**
    - **p99 latency**
- 면접관은 여기서:
    - “이 사람이 **증권 시스템을 ‘웹 서비스’로 착각하지 않는지**”를 봄

---

# 도메인 정리

### 1. 브로커 시스템

- 개인 사용자는 **거래소에 직접 접속하지 않음**
- 예:
    - Charles Schwab, Robinhood, Fidelity
    - (한국: 증권사 MTS/HTS)
- 역할:
    - 주문 생성
    - 시장 데이터 조회
    - 사용자 UI 제공

### 2. 기관 고객

- 기관 고객은 **전문 거래 소프트웨어**로 **대량 주문**을 처리한다.
- 기관별 요구사항이 다름:
    - **연기금(pension funds)**
        - 목표: 안정적 수익
        - 특징: 거래 빈도는 낮지만 거래량은 큼
        - 필요 기능: **주문 분할(order splitting)** 등으로 **시장 영향(슬리피지/충격) 최소화**
    - **헤지펀드(hedge funds)**
        - 시장 조성(market making) 등으로 수익
        - **수수료 리베이트(commission rebates)** 도 수익원이 됨
        - 요구: **매우 낮은 응답시간(초저지연)**
        - 일반 사용자처럼 웹/모바일로 데이터 보면 안 됨(전용 피드/프로토콜 필요)

📌 **중요 포인트**

→ 거래소는 **일반(브로커) 트래픽**과 **기관(초저지연/고빈도) 트래픽**을 함께 감당해야 함.

## 3. 주문 유형

### 지정가 주문 (Limit Order)

- **가격을 고정**한 매수/매도 주문
- **즉시 체결이 안 될 수 있음**
- **부분 체결**(partial fill)도 가능

### 시장가 주문 (Market Order)

- **가격을 지정하지 않음**
- **시장가로 즉시 체결**
- 체결은 보장되지만, 상황에 따라 **불리한 가격**으로 체결될 수 있음
- 급변하는 시장에서 유용

📌 의미

→ 매칭 엔진은 **가격 우선 → 시간 우선** 규칙만 구현하면 됨

## 4. 시장 데이터 수준

미국 주식시장의 price quote를 **3단계 레벨**로 설명

### L1 (Level 1)

![image.png](attachment:c14f9be5-8067-4eab-8653-8fe2b9e727c8:image.png)

- **최고 매수 호가(best bid)**, **최저 매도 호가(ask)** 와 **각 수량(quantity)**
- 정의
    - 최고 매수: “사려는 사람이 지불할 의사가 있는 가장 높은 가격”
    - 최저 매도: “팔려는 사람이 받아들이는 가장 낮은 가격”

### L2 (Level 2)

![image.png](attachment:1e61abe5-81ba-4e3a-a934-153f28909c5f:image.png)

- L1보다 더 많은 가격 레벨을 제공
- “깊이(depth)” = **호가창에서 체결 대기 물량을 어디까지 보여주는지**

### L3 (Level 3)

![image.png](attachment:e8506ab9-e7a6-4e30-ab17-22bc70f0b727:image.png)

- L2보다 더 상세
- 각 가격 레벨에서 **개별 주문 단위(어떤 주문들이 대기 중인지)** 까지 보여줌

## 5. 봉 차트

![image.png](attachment:cbc856df-7d87-4eb4-a048-4d5a2191ad0e:image.png)

- *봉 차트는 “특정 기간 동안의 주가 움직임”**을 한 개의 봉(캔들)로 요약해서 보여주는 방식.
- **한 봉(캔들) 1개가 담는 4가지 핵심 값**
    - **시작가(Open)**: 해당 기간 시작 가격
    - **종가(Close)**: 해당 기간 끝 가격
    - **최고가(High)**: 해당 기간 중 가장 높았던 가격
    - **최저가(Low)**: 해당 기간 중 가장 낮았던 가격
- 봉의 구성 요소
    - **실질적 주가 변화(Real body)**: 시작가~종가 구간
    - **위/아래 그림자(Upper/Lower shadow)**: 최고가·최저가까지의 꼬리
- 보통 지원되는 **시간 간격(캔들 단위)** 예시
    - **1분, 5분, 1시간, 1일, 1주, 1개월**
- 같은 데이터라도 **집계 주기에 따라 전혀 다른 봉**이 만들어짐
- **시장 데이터 흐름(Market Data Flow)**

👉 요약하면: _“캔들 하나 = 기간 내 OHLC(시가/종가/고가/저가) + 변동 범위”_

## 6. FIX (Financial Information eXchange Protocol)

- **FIX = 금융 정보 교환 프로토콜**
- **1991년에 만들어진**, 증권 거래 정보를 교환하기 위한 **기업 중립적(업계 표준) 통신 프로토콜**
- 역할/의미
    - 브로커·거래소·기관 시스템 간에 **주문/체결 같은 거래 메시지를 표준 포맷으로 주고받기** 위해 사용
- **중요 경로(Critical Path)** 에 위치
    - 주문
    - 체결 결과
- 특히:
    - 기관 고객
    - 초저지연 시스템
- 웹/REST/JSON ❌
- **FIX 또는 FIX 계열 바이너리 프로토콜** 선호

![image.png](attachment:568ed2d4-54a9-4b38-8be5-3c925c548087:image.png)

👉 요약하면: _“FIX는 거래 시스템끼리 주문/체결을 교환하는 업계 표준 메시지 규격(프로토콜)”_

---

# 개략적 설계안

![image.png](attachment:6b2fbd02-dc5f-41a8-9f5d-7a2a40b9e037:image.png)

- **브로커**: 로빈후드/골드만삭스 등. 고객 주문을 받아 거래소로 전달하고, 시장데이터를 받아 고객에게 제공
    
- **클라이언트 게이트웨이(Client Gateway)**: 거래소 입구
    
    - 입력 유효성 검사, 속도 제한(rate limit), 인증, 정규화(normalization) 같은 **게이트키핑**
- **주문 관리자(Order Manager)**: 주문 접수 후 **리스크 체크 + 자금 확인 + 라우팅**
    
- **지갑(Wallet)**: 주문을 넣기 위한 **자금 충분 여부 확인**(및 이후 락/해제의 기반)
    
- **체결 엔진(Matching Engine)**: 주문 매칭의 핵심. 주문서/호가창 유지 + 체결 생성
    
- **호가창/주문서(Order Book)**: 종목별 매수/매도 주문 대기열
    
- **시퀀서(Sequencer)**: 주문/집행(체결) 기록을 **일정 순서로 정렬**해서
    
    재생(replay)해도 항상 동일 결과가 나오게(결정론) 보장
    
- **시장 데이터 게시 서비스(Market Data Publish)**: 체결/주문 스트림으로 **봉 차트·호가창** 등 시장데이터 생성/배포
    
- **데이터 서비스(Data Service)**: 브로커가 **실시간 시장데이터를 조회**하는 인터페이스
    
- **보고 서비스(Reporter) + DB**: 주문/집행 기록에서 리포팅용 필드를 모아 **DB에 적재**
    

## 3가지 흐름정리

### A. 거래 흐름(Trading Flow) — **중요 경로(Critical Path)**, 지연 시간 가장 빡셈

**목표:** “주문이 들어와서 체결/통지까지”를 빠르게 끝내기

1. 고객이 브로커 앱에서 주문
    
2. 브로커가 거래소로 주문 전송
    
3. **클라이언트 게이트웨이** 통과(검증/제한/인증/정규화) → 주문 관리자로 전달
    
    4~5) **주문 관리자**가 규칙 기반 **위험성 점검(Risk check)** 수행
    
4. 위험성 점검 통과 시 **지갑 자금 충분 여부 확인**
    
    7~9) 주문을 **체결 엔진**으로 전달 → 매칭되면 **매수/매도 각각 1개씩 집행 기록(Execution/Fill) 2개 생성**
    
    - **시퀀서**가 주문/집행 기록을 정렬하여 **결정론적 결과** 보장
        
        10~14) 주문/집행 결과를 **클라이언트(브로커)로 통지**
        

> 핵심 포인트: 거래 흐름은 “빠름”이 최우선이라 **불필요한 후처리는 밖으로 뺀다**는 설계 의도가 깔려있어.

### B. 시장 데이터 흐름(Market Data Flow) — 읽기/분석용, **중요 경로 아님**

**목표:** “체결 결과를 시장데이터(봉/호가 등)로 가공해 브로커에 제공”

- **M1** 체결 엔진이 체결 시 **집행 기록 스트림** 생성 → 시장 데이터 게시 서비스로 전송
- **M2** 게시 서비스가 집행/주문 스트림으로 **봉 차트 + 호가창** 구성 → 데이터 서비스로 전달
- **M3** 시장 데이터를 **실시간 분석 전용 스토리지**에 저장 → 브로커가 데이터 서비스로 읽어 고객에게 제공

> 핵심 포인트: 시장데이터는 업데이트가 잦고(read 폭탄) 소비자가 많아서, 거래 핵심 경로와 **분리**하는 게 자연스럽다.

### C. 보고 흐름(Report Flow) — 적재/집계용, **중요 경로 아님**

**목표:** 규제/감사/정산/리포팅을 위한 “정형 레코드”를 DB에 남기기

- **R1~R2** Reporter가 주문/집행 기록에서 필요한 필드(예: client_id, price, quantity, order_type, filled_quantity, remaining_quantity 등)를 모아 **가공 레코드 생성 → DB 저장**

> 핵심 포인트: 보고는 “정확성/완전성”이 중요하지만, **ms 지연 요구는 거래 흐름만큼 높지 않다**.

## 핵심 메세지

- 거래소는 한 덩어리가 아니라,
    
    1. **거래(초저지연)**
        
    2. **시장데이터(대규모 팬아웃/읽기 폭탄)**
        
    3. **보고(적재/규제/감사)**
        
        이 3개를 **분리**해서 각각 다른 지연요건/확장전략으로 설계한다.
        
- 그리고 **결정론(deterministic) + 시퀀서**가 “고가용성”의 핵심 토대가 된다.